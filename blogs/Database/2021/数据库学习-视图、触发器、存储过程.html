<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据库-视图、触发器、存储过程 | DAIHAO_小破站</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/MyBlog/favicon.ico">
    <meta name="description" content="一花一世界，一叶一菩提">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/MyBlog/assets/css/0.styles.9c73a019.css" as="style"><link rel="preload" href="/MyBlog/assets/js/app.9dfd65aa.js" as="script"><link rel="preload" href="/MyBlog/assets/js/3.76fec40c.js" as="script"><link rel="preload" href="/MyBlog/assets/js/1.0933c2a3.js" as="script"><link rel="preload" href="/MyBlog/assets/js/19.3947f2e5.js" as="script"><link rel="prefetch" href="/MyBlog/assets/js/10.7e335e14.js"><link rel="prefetch" href="/MyBlog/assets/js/11.2c226f08.js"><link rel="prefetch" href="/MyBlog/assets/js/12.f391e4e7.js"><link rel="prefetch" href="/MyBlog/assets/js/13.83e0c801.js"><link rel="prefetch" href="/MyBlog/assets/js/14.9dec8f13.js"><link rel="prefetch" href="/MyBlog/assets/js/15.0c93a32c.js"><link rel="prefetch" href="/MyBlog/assets/js/16.809cac13.js"><link rel="prefetch" href="/MyBlog/assets/js/17.180fb657.js"><link rel="prefetch" href="/MyBlog/assets/js/18.427c2138.js"><link rel="prefetch" href="/MyBlog/assets/js/20.dc09376a.js"><link rel="prefetch" href="/MyBlog/assets/js/21.70e5f121.js"><link rel="prefetch" href="/MyBlog/assets/js/22.818293fa.js"><link rel="prefetch" href="/MyBlog/assets/js/23.d8307a2a.js"><link rel="prefetch" href="/MyBlog/assets/js/24.e586c895.js"><link rel="prefetch" href="/MyBlog/assets/js/25.7ba3d565.js"><link rel="prefetch" href="/MyBlog/assets/js/26.317ac9c6.js"><link rel="prefetch" href="/MyBlog/assets/js/27.971d85b5.js"><link rel="prefetch" href="/MyBlog/assets/js/28.b410d8b5.js"><link rel="prefetch" href="/MyBlog/assets/js/29.03bc1c8b.js"><link rel="prefetch" href="/MyBlog/assets/js/30.bd290479.js"><link rel="prefetch" href="/MyBlog/assets/js/31.664a5bab.js"><link rel="prefetch" href="/MyBlog/assets/js/32.6545d3ce.js"><link rel="prefetch" href="/MyBlog/assets/js/33.f6d59785.js"><link rel="prefetch" href="/MyBlog/assets/js/34.4f043f57.js"><link rel="prefetch" href="/MyBlog/assets/js/35.f258940b.js"><link rel="prefetch" href="/MyBlog/assets/js/36.b94e1d72.js"><link rel="prefetch" href="/MyBlog/assets/js/37.d3398d0a.js"><link rel="prefetch" href="/MyBlog/assets/js/38.07da415c.js"><link rel="prefetch" href="/MyBlog/assets/js/39.f7000e2d.js"><link rel="prefetch" href="/MyBlog/assets/js/4.1ae22871.js"><link rel="prefetch" href="/MyBlog/assets/js/40.184d9329.js"><link rel="prefetch" href="/MyBlog/assets/js/41.66a86df0.js"><link rel="prefetch" href="/MyBlog/assets/js/42.20ae4155.js"><link rel="prefetch" href="/MyBlog/assets/js/43.243d55ce.js"><link rel="prefetch" href="/MyBlog/assets/js/44.bcc3cad7.js"><link rel="prefetch" href="/MyBlog/assets/js/45.a80538a4.js"><link rel="prefetch" href="/MyBlog/assets/js/46.3b12b21d.js"><link rel="prefetch" href="/MyBlog/assets/js/47.7761cff9.js"><link rel="prefetch" href="/MyBlog/assets/js/48.958a1a67.js"><link rel="prefetch" href="/MyBlog/assets/js/49.f176aee9.js"><link rel="prefetch" href="/MyBlog/assets/js/5.9c753a0d.js"><link rel="prefetch" href="/MyBlog/assets/js/50.2988ca8a.js"><link rel="prefetch" href="/MyBlog/assets/js/51.59baebc3.js"><link rel="prefetch" href="/MyBlog/assets/js/52.23e7bd1a.js"><link rel="prefetch" href="/MyBlog/assets/js/53.a3a10635.js"><link rel="prefetch" href="/MyBlog/assets/js/54.e22d8f98.js"><link rel="prefetch" href="/MyBlog/assets/js/55.da49fb1b.js"><link rel="prefetch" href="/MyBlog/assets/js/56.d573388e.js"><link rel="prefetch" href="/MyBlog/assets/js/57.9b6b522b.js"><link rel="prefetch" href="/MyBlog/assets/js/58.e6c5903d.js"><link rel="prefetch" href="/MyBlog/assets/js/59.234a5618.js"><link rel="prefetch" href="/MyBlog/assets/js/6.5f174aba.js"><link rel="prefetch" href="/MyBlog/assets/js/60.5aace1ea.js"><link rel="prefetch" href="/MyBlog/assets/js/61.863336cb.js"><link rel="prefetch" href="/MyBlog/assets/js/62.c2a79bd2.js"><link rel="prefetch" href="/MyBlog/assets/js/63.f5381aa1.js"><link rel="prefetch" href="/MyBlog/assets/js/64.8c1967d0.js"><link rel="prefetch" href="/MyBlog/assets/js/65.36466ee6.js"><link rel="prefetch" href="/MyBlog/assets/js/66.1c80c948.js"><link rel="prefetch" href="/MyBlog/assets/js/67.df668fb9.js"><link rel="prefetch" href="/MyBlog/assets/js/68.c6c4a754.js"><link rel="prefetch" href="/MyBlog/assets/js/69.65a0eff4.js"><link rel="prefetch" href="/MyBlog/assets/js/7.c6b6bcfd.js"><link rel="prefetch" href="/MyBlog/assets/js/70.b7f9ccf0.js"><link rel="prefetch" href="/MyBlog/assets/js/71.7538a7d5.js"><link rel="prefetch" href="/MyBlog/assets/js/72.642b5376.js"><link rel="prefetch" href="/MyBlog/assets/js/73.868b6f45.js"><link rel="prefetch" href="/MyBlog/assets/js/74.dae475f6.js"><link rel="prefetch" href="/MyBlog/assets/js/75.375b08dd.js"><link rel="prefetch" href="/MyBlog/assets/js/76.e200006d.js"><link rel="prefetch" href="/MyBlog/assets/js/77.cf2e1cf7.js"><link rel="prefetch" href="/MyBlog/assets/js/78.2bcd8ae9.js"><link rel="prefetch" href="/MyBlog/assets/js/79.967a40d9.js"><link rel="prefetch" href="/MyBlog/assets/js/8.8f27f8dd.js"><link rel="prefetch" href="/MyBlog/assets/js/80.5487c462.js"><link rel="prefetch" href="/MyBlog/assets/js/81.3e7b391d.js"><link rel="prefetch" href="/MyBlog/assets/js/82.00ff1192.js"><link rel="prefetch" href="/MyBlog/assets/js/83.e9de1625.js"><link rel="prefetch" href="/MyBlog/assets/js/84.5467ba10.js"><link rel="prefetch" href="/MyBlog/assets/js/85.205c04fc.js"><link rel="prefetch" href="/MyBlog/assets/js/9.4219d779.js">
    <link rel="stylesheet" href="/MyBlog/assets/css/0.styles.9c73a019.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-2d5f533b><div data-v-2d5f533b><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-2d5f533b data-v-2d5f533b><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-2d5f533b data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>DAIHAO_小破站</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>DAIHAO</span>
            
          <!---->
          2025
        </a></span></div></div> <div class="hide" data-v-2d5f533b><header class="navbar" data-v-2d5f533b><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/MyBlog/" class="home-link router-link-active"><img src="/MyBlog/logo.png" alt="DAIHAO_小破站" class="logo"> <span class="site-name">DAIHAO_小破站</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/MyBlog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MyBlog/categories/Database/" class="nav-link"><i class="iconfont undefined"></i>
  Database
</a></li><li class="dropdown-item"><!----> <a href="/MyBlog/categories/Java/" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/MyBlog/categories/Spring/" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/MyBlog/categories/SpringBoot/" class="nav-link"><i class="iconfont undefined"></i>
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/MyBlog/categories/Vue/" class="nav-link"><i class="iconfont undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/MyBlog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/MyBlog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MyBlog/docs/DAIHAO/" class="nav-link"><i class="iconfont undefined"></i>
  DAIHAO
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MyBlog/blogs/Database/2021/.html" class="nav-link"><i class="iconfont reco-github"></i>
  GitHub
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-2d5f533b></div> <aside class="sidebar" data-v-2d5f533b><div class="personal-info-wrapper" data-v-ca798c94 data-v-2d5f533b><img src="/MyBlog/avatar.png" alt="author-avatar" class="personal-img" data-v-ca798c94> <h3 class="name" data-v-ca798c94>
    DAIHAO
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>73</h3> <h6 data-v-ca798c94>Article</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>36</h3> <h6 data-v-ca798c94>Tag</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><a href="/MyBlog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MyBlog/categories/Database/" class="nav-link"><i class="iconfont undefined"></i>
  Database
</a></li><li class="dropdown-item"><!----> <a href="/MyBlog/categories/Java/" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/MyBlog/categories/Spring/" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/MyBlog/categories/SpringBoot/" class="nav-link"><i class="iconfont undefined"></i>
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/MyBlog/categories/Vue/" class="nav-link"><i class="iconfont undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/MyBlog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/MyBlog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MyBlog/docs/DAIHAO/" class="nav-link"><i class="iconfont undefined"></i>
  DAIHAO
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/MyBlog/blogs/Database/2021/.html" class="nav-link"><i class="iconfont reco-github"></i>
  GitHub
</a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>数据库-视图、触发器、存储过程</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>DAIHAO</span>
            
          <!---->
          2025
        </a></span></div></div> <div data-v-2d5f533b><main class="page" style="padding-right:0;"><div class="page-title" style="display:none;"><h1 class="title">数据库-视图、触发器、存储过程</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>DAIHAO</span></i> <i class="iconfont reco-date" data-v-3b7f5bdf><span data-v-3b7f5bdf>2021-04-05</span></i> <i class="iconfont reco-eye" data-v-3b7f5bdf><span id="/MyBlog/blogs/Database/2021/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%A6%E4%B9%A0-%E8%A7%86%E5%9B%BE%E3%80%81%E8%A7%A6%E5%8F%91%E5%99%A8%E3%80%81%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-3b7f5bdf><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="iconfont reco-tag tags" data-v-3b7f5bdf><span class="tag-item" data-v-3b7f5bdf>sql</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><p># 数据视图</p> <ul><li>复用性：数据库中关于数据的查询有时候非常复杂，例如表连接，子查询等，这种查询会让程序员感到非常痛苦，因为它逻辑复杂，编写语句较多，这种查询需要重复使用时，则不会次次都能编写成功，从而降低了数据库的实用性。</li> <li>安全性：在操作表时，有时候只要求程序员只能操作部分字段，而不是全部字段。比如在公司，工资一般是保密的，如果因为程序员一时疏忽多写入一个”工资“字段，则会让员工的工资显示给所有人，这就需要限制程序员操作的字段。</li></ul> <p>所以为了提高复杂SQL语句的复用性和安全性，则可以使用视图。</p> <p><strong>视图</strong>：本质上是一种虚拟表，其内容与真实的表相似，包含一系列带有名称的列和行数据，但是，视图并不在数据库中以存储的数据值形式存在。行和列数据来自定义视图的查询所引用基本表，并不在具体引用视图时动态生成。</p> <p>视图使程序员只关心需要的数据和所负责的特定任务，这样程序员只能看到视图中定义的数据，而不是视图所引用表中的数据，从而提高数据库中数据的安全性。</p> <p><strong>视图特点</strong></p> <ul><li>视图的列可以来自不同的表，是表的抽象和逻辑意义上建立的新关系</li> <li>视图是由基本表（实表）产生的虚表</li> <li>视图的建立和删除不影响基本表</li> <li>对视图内容的更新（添加删除修改）直接影响基本表</li> <li>当视图来自多个基本表时，不允许添加和删除数据</li></ul> <p><strong>创建视图语法</strong></p> <blockquote><p>create view view_name as 查询语句</p></blockquote> <p>和创建表一样，视图名不能重复，从语法可发现，视图的功能其实就是封装了复杂的查询语句。</p> <p>查询视图</p> <blockquote><p>select * from view_name</p></blockquote> <p><a href="https://www.yiibai.com/mysql/views.html" target="_blank" rel="noopener noreferrer">MySQL视图<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://www.yiibai.com/sqlserver/sql-server-views.html#" target="_blank" rel="noopener noreferrer">SQL Server视图<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h1 id="触发器"><a href="#触发器" class="header-anchor">#</a> 触发器</h1> <p>SQL触发器是存储在数据库目录中的一组SQL语句。每当与表相关联的事件发生时，即会执行或触发SQL触发器，例如插入，更新或删除。</p> <p>SQL触发器是一种特殊类型的存储过程。与一般存储过程不同的是，触发器不是被调用执行，而是当对表执行数据修改事件时，会自动调用触发器，而存储过程必须要明确地调用。触发器不能传递参数和接受参数。它与数据表关系密切，一般用于实现比较复杂的数据完整性规则、检查数据的有效性、实现对用户操作和数据状态的实时监控、实现数据库的一些管理任务和其他的一些附加功能等。</p> <p><strong>SQL触发器的优点</strong></p> <p>SQL触发器提供了检查数据完整性的替代方法。SQL触发器可以捕获数据库层中业务逻辑中的错误。SQL触发器提供了运行计划任务的另一种方法。通过使用SQL触发器，您不必等待运行计划的任务，因为在对表中的数据进行更改之前或之后自动调用触发器。SQL触发器对于审核表中数据的更改非常有用。</p> <p><strong>SQL触发器的缺点</strong></p> <p>SQL触发器只能提供扩展验证，并且无法替换所有验证。一些简单的验证必须在应用层完成。 例如，您可以使JavaScript或服务器端使用服务器端脚本语言(如JSP，PHP，ASP.NET，Perl等)来验证客户端的用户输入。从客户端应用程序调用和执行SQL触发器不可见，因此很难弄清数据库层中发生的情况。SQL触发器可能会增加数据库服务器的开销。</p> <blockquote><p>DML触发器</p></blockquote> <p>数据库操纵语言（DML）主要包含INSERT、UPDATE、DELETE等语句。这些语句作用于数据表或视图的时候，将产生相应的事件——DML事件。此类事件一旦发生可引起相关触发器的执行，因此这类事件通常称为DML事件，相应的触发器称为DML触发器。也可以这样理解，DML触发器是在运行DML语句时由于产生DML事件而被执行的一类触发器。</p> <p>根据触发器的执行与触发事件发生的先后关系，又可以将DML触发器分为AFTER触发器和INSTEAD OF触发器。</p> <blockquote><p>AFTER触发器：</p></blockquote> <p>在DML触发事件发生后才激发执行的触发器，也就是说，先执行INSERT、UPDATE、DELETE语句然后才执行AFTER触发器。这类触发器只适用于数据表，不适用于视图。AFTER触发器一般用于检查数据的变动情况，以便采取相应的措施。例如，如发现错误，将拒绝或回滚更改的数据；</p> <blockquote><p>INSTEAD OF触发器：“</p></blockquote> <p>INSTEAD OF”的中文意思就是“代替”之意，由此不难理解：INSTEAD OF触发器是在DML触发事件发生之前（即数据被更新之前）执行的，这种执行将代替DML语句的执行。也就是说，INSTEAD OF触发器是在DML触发事件发生之前执行，并且取代相应的DML语句（INSERT、UPDATE或DELETE语句），转而去执行INSTEAD OF触发器定义的操作（此后不再执行此DML语句）。INSTEAD OF触发器既适用于数据表，也适用于视图。但对同一个操作只能定义一个INSTEAD OF触发器。</p> <p>如果根据触发事件的类型划分，DML触发器通常又可以分为INSERT触发器、UPDATE触发器和DELETE触发器：</p> <blockquote><p>INSERT触发器：执行INSERT语句而激发执行的触发器；</p></blockquote> <blockquote><p>UPDATE触发器：执行UPDATE语句而激发执行的触发器；</p></blockquote> <blockquote><p>DELETE触发器：执行DELETE语句而激发执行的触发器。</p></blockquote> <blockquote><p>DDL触发器</p></blockquote> <p>DDL触发器是一种由执行DDL语句产生触发事件而触发执行的触发器。DDL语句包括CREATE、ALTER、DROP、GRANT、DENY、REVOKE 和UPDATE STATISTICS 等语句。</p> <p>Ø 与DML触发器不同的是，DDL触发器的触发事件是执行DDL语句而引起的事件，这种触发器是在触发事件发生后执行的；而DML触发器的触发事件则是由执行DML语句引起的，可在事件发生前或发生后执行。另外，DDL触发器的作用域不是架构，因而不能使用OBJECT_ID来查询有关DDL触发器的元数据。DDL触发器可用于执行数据库级的管理任务，如审核和规范数据库操作等。</p> <p>DML触发器的触发事件类型比较简单，主要包括INSERT、DELETE和UPDATE等三种事件。但DDL触发器的触发事件就比较多，表9.1列了出常用的几种事件。记住这几种事件对以后的触发器编程很有帮助。</p> <blockquote><p>LOGON触发器（登录触发器）</p></blockquote> <p>登录触发器是SQL Server 2005开始新增加的一类为响应LOGON事件（登录）而激发执行的触发器。也就是说，只要有用户登录，登录触发器即可激发执行。因此，通过登录触发器可以知道谁登录了服务器以及何时登录的，并可以实现如何跟踪用户的活动，还可以限制特定用户只能在特定时间段登录等。</p> <p>触发事件对触发器来说是关键的，所以许多时候又用引发触发事件的SQL语句来对触发器进行分类和命名。</p> <blockquote><p>INSERT触发器、DELETE触发器、UPDATE触发器等。但这种分类不是严格的，只是为阐明问题之便。</p></blockquote> <p><strong>创建DML触发器</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> <span class="token punctuation">[</span> schema_name<span class="token punctuation">.</span> <span class="token punctuation">]</span>trigger_name
<span class="token keyword">ON</span> { <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">view</span> }
<span class="token punctuation">[</span> <span class="token keyword">WITH</span> <span class="token operator">&lt;</span>dml_trigger_option<span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>n <span class="token punctuation">]</span> <span class="token punctuation">]</span>
{ <span class="token keyword">FOR</span> <span class="token operator">|</span> <span class="token keyword">AFTER</span> <span class="token operator">|</span> INSTEAD <span class="token keyword">OF</span> }
{ <span class="token punctuation">[</span> <span class="token keyword">INSERT</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token keyword">UPDATE</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token keyword">DELETE</span> <span class="token punctuation">]</span> }
<span class="token punctuation">[</span> <span class="token keyword">WITH</span> APPEND <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token operator">NOT</span> <span class="token keyword">FOR</span> <span class="token keyword">REPLICATION</span> <span class="token punctuation">]</span>
<span class="token keyword">AS</span> { sql_statement  <span class="token punctuation">[</span> <span class="token punctuation">;</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>n <span class="token punctuation">]</span> <span class="token operator">|</span> EXTERNAL NAME <span class="token operator">&lt;</span>method specifier <span class="token punctuation">[</span> <span class="token punctuation">;</span> <span class="token punctuation">]</span> <span class="token operator">&gt;</span> }
<span class="token operator">&lt;</span>dml_trigger_option<span class="token operator">&gt;</span> ::<span class="token operator">=</span> <span class="token punctuation">[</span> ENCRYPTION <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">AS</span> Clause <span class="token punctuation">]</span>
<span class="token operator">&lt;</span>method_specifier<span class="token operator">&gt;</span> ::<span class="token operator">=</span> assembly_name<span class="token punctuation">.</span>class_name<span class="token punctuation">.</span>method_name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>参数说明如下：</p> <ul><li><p>trigger_name：设置触发器的名称，但不能以#或##开头。</p></li> <li><p>schema_name：设置触发器所属架构的名称。</p></li> <li><p>table | view：执行DML触发器的表或视图，也分别称为触发器表或触发器视图。</p></li> <li><p>WITH ENCRYPTION：选择该子句，则表示对触发器文本进行加密。</p></li> <li><p>EXECUTE AS：指定用于执行该触发器的安全上下文，即设置操作权限。</p></li> <li><p>AFTER：表示定义AFTER触发器，即DML触发器在触发事件发生后执行。如果仅指定FOR关键字，则默认使用AFTER。</p></li> <li><p>INSTEAD OF：表示定义INSTEAD OF触发器，即DML触发器在触发事件发生之前执行。</p></li> <li><p>{ [DELETE] [,] [INSERT] [,] [UPDATE] }：指定触发事件，如果选择了DELETE，则表示创建DELETE触发器，其他类推。</p></li> <li><p>WITH APPEND：指定添加一个与当前触发器类型相同的另外一个触发器。该子句不适用于INSTEAD OF触发器。该功能在未来中将被删除，建议不要使用。</p></li> <li><p>NOT FOR REPLICATION：该选项用于指示复制代理修改到触发器表时不执行触发器。</p></li> <li><p>sql_statement：SQL语句。</p></li> <li><p>&lt; method_specifier &gt;：只适用于CLR触发器，指定程序集与触发器绑定的方法。</p></li></ul> <p>如果在CREATE TRIGGER语句中选择了INSERT 、UPDATE或DELETE选项，则表示创建INSERT，UPDATE或DELETE触发器。对于这类触发器（DML触发器），有两种临时表与它们有着密切的联系，它们是表DELETED和表INSERTED。这两种临时表都是在触发器执行时被创建，执行完毕后被删除。对它们的维护和管理是由SQL Server自动完成，用户不能对这两个表进行直接操作。</p> <p>具体地，在执行INSERT触发器时创建表INSERTED，执行DELETE触发器时创建表DELETED，执行UPDATE触发器时则同时创建表INSERTED和表DELETED，其中表INSERTED保存了更新的数据记录，表DELETED则保存更新前的数据记录（不受到更新影响的记录不含在其中）。</p> <blockquote><p>SQL Server对这两个表的操作过程如下：
INSERTED：在执行INSERT或UPDATE语句时，对用于插入或用于更新的数据记录拷贝一个副本，并将该副本保存到表INSERTED中。可见，表INSERTED是触发器表被插入或被更新后的一个子集。
DELETED：在执行DELETE和UPDATE语句时，将触发器表中被删除或被更新的数据记录拷贝到表DELETED中。可见表DELETED和触发器表是不相交的（不会含有相同的记录）。</p></blockquote> <p>假设表param是参数表，有code和name两个字段，在保存修改是不允许code重复。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">USE</span> dbo
GO
<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> checkcode_trigger <span class="token keyword">ON</span> param
<span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span><span class="token punctuation">,</span><span class="token keyword">UPDATE</span>
<span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">DECLARE</span> <span class="token variable">@code</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@n</span> <span class="token keyword">int</span><span class="token punctuation">;</span>
  <span class="token keyword">SELECT</span> <span class="token variable">@code</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>code             <span class="token comment">-- 将正在插入的记录的code字段值保存在@code中</span>
  <span class="token keyword">FROM</span> param <span class="token keyword">AS</span> p 
<span class="token keyword">SELECT</span> <span class="token variable">@n</span> <span class="token operator">=</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>                 <span class="token comment">-- 在表param中查找是否有code字段值等于@code的学生</span>
  <span class="token keyword">FROM</span> param
  <span class="token keyword">WHERE</span> code <span class="token operator">=</span> <span class="token variable">@code</span><span class="token punctuation">;</span>  
<span class="token keyword">IF</span> <span class="token variable">@n</span> <span class="token operator">&gt;</span> <span class="token number">1</span>
  <span class="token keyword">BEGIN</span>
     <span class="token keyword">RAISERROR</span> <span class="token punctuation">(</span><span class="token string">'code不能重复'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">ROLLBACK</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>   <span class="token comment">-- 回滚（撤销前面的插入修改操作）</span>
   <span class="token keyword">END</span>
   <span class="token keyword">ELSE</span> <span class="token keyword">PRINT</span> <span class="token string">'执行成功'</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>
GO
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>出于某种原因（如学生因退学、出国而取消学籍），有时候需要将表student中的记录删除，这时也应该将表SC中对应学生的选课信息删除，以保持数据库的完整性。这种完整性的保持可以通过定义如下的AFTER触发器来实现。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">USE</span> MyDatabase
<span class="token constant">GO</span>
<span class="token constant">CREATE</span> <span class="token constant">TRIGGER</span> myTrigger3 <span class="token constant">ON</span> student
<span class="token constant">AFTER</span> <span class="token constant">DELETE</span>
<span class="token constant">AS</span>
<span class="token constant">BEGIN</span>
  <span class="token constant">DECLARE</span> @s_no <span class="token function">char</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">SELECT</span> @s_no <span class="token operator">=</span> <span class="token constant">I</span><span class="token punctuation">.</span>s_no        
  <span class="token constant">FROM</span> <span class="token constant">DELETED</span> <span class="token constant">AS</span> <span class="token constant">I</span><span class="token punctuation">;</span>
  <span class="token constant">DELETE</span> <span class="token constant">FROM</span> <span class="token constant">SC</span>
  <span class="token constant">WHERE</span> s_no <span class="token operator">=</span> @s_no<span class="token punctuation">;</span>
<span class="token constant">END</span>
<span class="token constant">GO</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>该触发器的作用就是，当在表student中删除某一条件记录时，表SC中与该记录对应的记录（字段s_no值相同的记录）将自动被删除，以保持两个表中数据的参照完整性。</p></blockquote> <p><strong>修改触发器</strong></p> <p>触发器的修改是由ALTER TRIGGER语句来完成。但修改不同类型的触发器，ALTER TRIGGER语句的语法是不相同的。</p> <p>以下分别是修改DML触发器和DDL触发器的SQL语句：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TRIGGER</span> schema_name<span class="token punctuation">.</span>trigger_name      <span class="token comment">-- 修改DML触发器</span>
<span class="token keyword">ON</span> <span class="token punctuation">(</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">view</span> <span class="token punctuation">)</span>
<span class="token punctuation">[</span> <span class="token keyword">WITH</span> <span class="token operator">&lt;</span>dml_trigger_option<span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>n <span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">(</span> <span class="token keyword">FOR</span> <span class="token operator">|</span> <span class="token keyword">AFTER</span> <span class="token operator">|</span> INSTEAD <span class="token keyword">OF</span> <span class="token punctuation">)</span>
{ <span class="token punctuation">[</span> <span class="token keyword">DELETE</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token keyword">INSERT</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token keyword">UPDATE</span> <span class="token punctuation">]</span> }
<span class="token punctuation">[</span> <span class="token operator">NOT</span> <span class="token keyword">FOR</span> <span class="token keyword">REPLICATION</span> <span class="token punctuation">]</span>
<span class="token keyword">AS</span> { sql_statement <span class="token punctuation">[</span> <span class="token punctuation">;</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>n <span class="token punctuation">]</span> <span class="token operator">|</span> EXTERNAL NAME <span class="token operator">&lt;</span>method specifier<span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">;</span> <span class="token punctuation">]</span> }
<span class="token operator">&lt;</span>dml_trigger_option<span class="token operator">&gt;</span> ::<span class="token operator">=</span> <span class="token punctuation">[</span> ENCRYPTION <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token operator">&lt;</span><span class="token keyword">EXECUTE</span> <span class="token keyword">AS</span> Clause<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token operator">&lt;</span>method_specifier<span class="token operator">&gt;</span> ::<span class="token operator">=</span> assembly_name<span class="token punctuation">.</span>class_name<span class="token punctuation">.</span>method_name

<span class="token keyword">ALTER</span> <span class="token keyword">TRIGGER</span> trigger_name        <span class="token comment">-- 修改DDL触发器</span>
<span class="token keyword">ON</span> { <span class="token keyword">DATABASE</span> <span class="token operator">|</span> <span class="token keyword">ALL</span> SERVER }
<span class="token punctuation">[</span> <span class="token keyword">WITH</span> <span class="token operator">&lt;</span>ddl_trigger_option<span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>n <span class="token punctuation">]</span> <span class="token punctuation">]</span>
{ <span class="token keyword">FOR</span> <span class="token operator">|</span> <span class="token keyword">AFTER</span> } { event_type <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>n <span class="token punctuation">]</span> <span class="token operator">|</span> event_group }
<span class="token keyword">AS</span> { sql_statement <span class="token punctuation">[</span> <span class="token punctuation">;</span> <span class="token punctuation">]</span> <span class="token operator">|</span> EXTERNAL NAME <span class="token operator">&lt;</span>method specifier<span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">;</span> <span class="token punctuation">]</span> }
}
<span class="token operator">&lt;</span>ddl_trigger_option<span class="token operator">&gt;</span> ::<span class="token operator">=</span> <span class="token punctuation">[</span> ENCRYPTION <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token operator">&lt;</span><span class="token keyword">EXECUTE</span> <span class="token keyword">AS</span> Clause<span class="token operator">&gt;</span> <span class="token punctuation">]</span>
<span class="token operator">&lt;</span>method_specifier<span class="token operator">&gt;</span> ::<span class="token operator">=</span> assembly_name<span class="token punctuation">.</span>class_name<span class="token punctuation">.</span>method_name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>其中涉及的参数与触发器定义语法中的参数一样。注意，不能为DDL触发器指定架构schema_name。</p> <p>修改触发器的优点：主要是用户拥有对它的操作权限不会因为对触发器的修改而发生改变。另外，如果原来的触发器定义时使用WITH ENCRYPTION或WITH RECOMPILE选项创建的，只有在ALTER TRIGGER中也包含这些选项时，这些选项才有效。</p> <p><strong>禁用和删除触发器</strong></p> <p>有时候（特别是在调试阶段）我们并不希望频繁地触发执行一些触发器，但又不能将之删除，这时最好先禁用这些触发器。</p> <p>禁用一段时间以后，一般还需重新启用它，这又要涉及到触发器启用的概念。</p> <p>以下分别是禁用和启用触发器的SQL语法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">DISABLE</span> <span class="token constant">TRIGGER</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span> schema<span class="token punctuation">.</span> <span class="token punctuation">]</span> trigger_name <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token operator">...</span>n <span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token constant">ALL</span> <span class="token punctuation">}</span>
<span class="token constant">ON</span> <span class="token punctuation">{</span> object_name <span class="token operator">|</span> <span class="token constant">DATABASE</span> <span class="token operator">|</span> <span class="token constant">ALL</span> <span class="token constant">SERVER</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span> <span class="token punctuation">;</span> <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">ENABLE</span> <span class="token constant">TRIGGER</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span> schema_name <span class="token punctuation">.</span> <span class="token punctuation">]</span> trigger_name <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token operator">...</span>n <span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token constant">ALL</span> <span class="token punctuation">}</span>
<span class="token constant">ON</span> <span class="token punctuation">{</span> object_name <span class="token operator">|</span> <span class="token constant">DATABASE</span> <span class="token operator">|</span> <span class="token constant">ALL</span> <span class="token constant">SERVER</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span> <span class="token punctuation">;</span> <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>参数说明如下：</p> <ul><li><p>trigger_name：要禁用的触发器的名称。</p></li> <li><p>schema_name：触发器所属架构的名称。但DDL触发器没有架构。</p></li> <li><p>ALL：如果选择该选项，则表示对定义在ON子句作用域中的所有触发器全部禁用。</p></li> <li><p>object_name：触发器表或视图的名称。</p></li> <li><p>DATABASE：将作用域设置为整个数据库。</p></li> <li><p>ALL SERVER：将作用域设置为整个服务器。</p></li></ul> <p><strong>删除触发器</strong></p> <p>当确信一个触发器不再使用时，应当将之删除。DML触发器和DDL触发器的删除方法有所不同，以下分别是删除这两种触发器的SQL语法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">DROP</span> <span class="token constant">TRIGGER</span> schema_name<span class="token punctuation">.</span>trigger_name <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token operator">...</span>n <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">;</span> <span class="token punctuation">]</span>  <span class="token operator">--</span> 删除<span class="token constant">DML</span>触发器
<span class="token constant">DROP</span> <span class="token constant">TRIGGER</span> trigger_name <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token operator">...</span>n <span class="token punctuation">]</span> <span class="token constant">ON</span> <span class="token punctuation">{</span> <span class="token constant">DATABASE</span> <span class="token operator">|</span> <span class="token constant">ALL</span> <span class="token constant">SERVER</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span> <span class="token punctuation">;</span> <span class="token punctuation">]</span> <span class="token operator">--</span> 删除<span class="token constant">DDL</span>触发器
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在删除DDL触发器时需要指定触发器名称和作用域（即，是DATABASE还是ALL SERVER），而删除DML触发器时则只需指定其名称。</p> <h1 id="存储过程"><a href="#存储过程" class="header-anchor">#</a> 存储过程</h1> <p>存储过程是指封装了可重用代码的、存储在服务器上的程序模块或例程。存储过程是数据库对象之一，它类似于其他高级编程语言中的过程或子程序，编译成可执行代码后保存在服务器上，可多次调用。</p> <p>其特点体现在：</p> <ul><li><p>可以接受多个输入参数，能够以多输出参数的格式返回多个值。</p></li> <li><p>在服务器端运行，使用EXECUTE（简写为EXEC）语句来执行。</p></li> <li><p>可以调用其他存储过程，也可以被其他语句或存储过程调用，但不能直接在表达式中使用。</p></li> <li><p>具有返回状态值，表明被调用是成功还是失败。但不返回取代其名称的值，这是它与函数的不同之处。</p></li> <li><p>存储过程已在服务器注册。</p></li></ul> <p>存储过程的优点主要体现在：</p> <ul><li><p>提高程序的执行效率。存储过程执行在第一次被执行以后，其执行规划就驻留在高速缓冲存储器中。在以后的每次操作中，只需从高速缓冲存储器中调用已编译好的二进制代码执行即可，而不必重新编译再执行，从而提高了执行效率。</p></li> <li><p>具有较高的安全特性。作为一种数据库对象，存储过程要求拥有相应权限的用户才能执行它。同时，它也提供了一种更为灵活的安全性管理机制：用户可以被授予权限来执行存储过程，而不必对存储过程中引用的对象拥有访问权限。</p></li> <li><p>如果一个存储过程是用于更新某一个数据表的，那么只要用户拥有执行该存储过程的权限，他就可以通过执行该存储过程的方法来实现对指定数据表的更新操作，而不必直接拥有对该数据表操作的权限。</p></li> <li><p>减少网络通信流量。由于存储过程在服务器端执行，用户每次只需发出一条执行命令，而不必发出存储过程所有的冗长代码，因而减少了网络的数据流量。</p></li> <li><p>允许模块化程序设计，提高代码的可重用性。存储过程一旦被创建，以后就可以在所有程序中多次调用。这有利于程序的结构化设计，提高程序的可维护性和代码的可重用性。</p></li></ul> <p><strong>存储过程的类型</strong></p> <ul><li><p>在SQL Server 2008中，存储过程可以分为两种类型：SQL存储过程和CLR存储过程。SQL存储过程是指出由SQL语言编写而形成的存储过程，它是SQL语句的集合。CLR(Common Language Runtime)存储过程是指引用Microsoft.NET Framework公共语言运行时(CLR)方法的存储过程，它在.NET Framework程序集中是作为类的公共静态方法实现的。</p></li> <li><p>根据来源和应用目的的不同，又可以将存储过程分为用户存储过程、系统存储过程和扩展存储过程。</p></li></ul> <blockquote><p>系统存储过程</p></blockquote> <p>系统存储过程是SQL Server 2008本身定义的、当作命令来执行的一类存储过程。它主要用于管理SQL Server 数据库和显示有关数据库及用户的信息，通常前缀“sp_”。</p> <p>sp_addrolemember就是一个用于为数据库角色添加成员的系统存储过程。从逻辑结构看，系统存储过程出现在每个系统定义数据库和用户定义数据库的sys构架中。读者最好能够熟悉一些常用的系统存储过程，以免重复开发。</p> <blockquote><p>用户存储过程</p></blockquote> <p>用户存储过程是指由用户通过利用SQL语言编写的、具有特定功能的一类存储过程。由于系统存储过程以“sp_”为前缀，扩展存储过程以“xp_”，所以用户存储过程在定义时最好不要使用“sp_”或“xp_”为前缀。如果需要，用户存储过程应以“up_”为前缀，“u”是单词user的头字母。</p> <blockquote><p>扩展存储过程</p></blockquote> <p>扩展存储过程是指SQL Server的实例可以动态加载和运行的动态链接库（DLL）。通过扩展存储过程，可以使用其他编程语言（如C语句）创建自己的外部程序，实现了SQL程序与其他语言程序的连接与融合。</p> <p>扩展存储过程直接在SQL Server的实例地址空间中运行，可以使用SQL Server扩展存储过程API完成编程。但由于后续的SQL Server版本中将不支持扩展存储过程，所以在新的工程开发项目中应尽量少用或不用这种功能。</p> <p><strong>存储过程的创建和调用</strong></p> <p>存储过程是由<code>CREATE PROCEDURE</code>语句来创建，其语法如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">CREATE</span> <span class="token punctuation">{</span> <span class="token constant">PROC</span> <span class="token operator">|</span> <span class="token constant">PROCEDURE</span> <span class="token punctuation">}</span> <span class="token punctuation">[</span>schema_name<span class="token punctuation">.</span><span class="token punctuation">]</span> procedure_name <span class="token punctuation">[</span> <span class="token punctuation">;</span> number <span class="token punctuation">]</span>
  <span class="token punctuation">[</span> <span class="token punctuation">{</span> @parameter <span class="token punctuation">[</span> type_schema_name<span class="token punctuation">.</span> <span class="token punctuation">]</span> data_type <span class="token punctuation">}</span>
      <span class="token punctuation">[</span> <span class="token constant">VARYING</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token operator">=</span> <span class="token keyword">default</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token constant">OUT</span> <span class="token punctuation">[</span> <span class="token constant">PUT</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token operator">...</span>n <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token constant">WITH</span> <span class="token operator">&lt;</span>procedure_option<span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token operator">...</span>n <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token constant">FOR</span> <span class="token constant">REPLICATION</span> <span class="token punctuation">]</span>
<span class="token constant">AS</span> <span class="token punctuation">{</span> <span class="token operator">&lt;</span>sql_statement<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">;</span><span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token operator">...</span>n <span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token operator">&lt;</span>method_specifier<span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">;</span><span class="token punctuation">]</span>

<span class="token operator">&lt;</span>procedure_option<span class="token operator">&gt;</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">=</span>
    <span class="token punctuation">[</span> <span class="token constant">ENCRYPTION</span> <span class="token punctuation">]</span>
    <span class="token punctuation">[</span> <span class="token constant">RECOMPILE</span> <span class="token punctuation">]</span>
    <span class="token punctuation">[</span> EXECUTE_AS_Clause <span class="token punctuation">]</span>

<span class="token operator">&lt;</span>sql_statement<span class="token operator">&gt;</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span> <span class="token constant">BEGIN</span> <span class="token punctuation">]</span> statements <span class="token punctuation">[</span> <span class="token constant">END</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>

<span class="token operator">&lt;</span>method_specifier<span class="token operator">&gt;</span> <span class="token operator">:</span><span class="token operator">:</span><span class="token operator">=</span> <span class="token constant">EXTERNAL</span> <span class="token constant">NAME</span> assembly_name<span class="token punctuation">.</span>class_name<span class="token punctuation">.</span>method_name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>对涉及的参数说明如下：</p> <ul><li><p>schema_name：设定存储过程所属架构的名称。</p></li> <li><p>procedure_name：存储过程的名称。它是一个合法的标识符，在架构中是唯一的。存储过程名一般不能使用前缀“sp_”，此前缀由系统存储过程使用。如果过程名以井号“#”开头，则表示创建的过程将局部临时过程，这种过程名的长度不超116个字符（含#）；如果以双井号“##”开头，则表示是全局临时过程，这种过程名的长度不超128个字符（含##）。</p></li> <li><p>number：用于对同名的存储过程进行分组的整数。例如，myPro;1、myPro;2等。</p></li> <li><p>@parameter：存储过程带的参数，data_type为参数所属架构的数据类型。参数可以是一个或者多个，最多为2,100个参数。在定义时参数可以设置默认值，而对于没有设置默认值的参数，在调用时必须为其提供值。在默认情况下，参数只能代表常量表达式，而不能用于代表表名、列名或其他数据库对象的名称。如果指定了FOR REPLICATION，则无法声明参数。</p></li> <li><p>OUTPUT（或OUT）：如果指定了OUTPUT（或OUT），则表示该参数为输出参数。输出参数用于将存储过程处理后的某些结果返回给调用它的语句。游标（cursor）数据类型参数必须指定OUTPUT，同时还必须指定关键字VARYING。一般情况下，text、ntext和image类型参数不能用作OUTPUT 参数。</p></li> <li><p>VARYING：指定输出参数支持的结果集。仅适用于游标类型参数。</p></li> <li><p>default：设定参数的默认值。如果定义了default值，则在调用存储过程时无需为此参数指定值，否则必须指定参数值才能调用。默认值必须是常量或NULL。</p></li> <li><p>RECOMPILE：该选项用于指示SQL Server不要将存储过程的执行规划保存在高速缓冲存储器中，因为该过程在执行时要重新编译，然后才运行。如果指定了FOR REPLICATION，则不能使用此选项。</p></li> <li><p>ENCRYPTION：指示SQL Server对CREATE PROCEDURE语句的原始文本进行加密，加密后的代码的输出在SQL Server 2008的任何目录视图中都不能直接显示。</p></li> <li><p>EXECUTE AS：该子句用于指定在其中执行存储过程的安全上下文。</p></li> <li><p>FOR REPLICATION：如果选择该选项，则表示创建的存储过程只能在复制过程中执行。该类过程不能声明参数，忽略RECOMPILE选项。</p></li> <li><p>&lt;sql_statement&gt;：表示包含在过程中的一个或多个SQL语句。</p></li> <li><p>&lt;method_specifier&gt;：CLR存储过程的标识。assembly_name.class_name.method_name用于指定.NET Framework程序集的方法，以便CLR存储过程引用。</p></li></ul> <blockquote><p>（简单的存储过程）创建一个存储过程，它可以输出学生的学号、姓名、平均成绩以及所在系别。</p></blockquote> <p>该过程名为“myPro1”，所使用的SQL语句如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">USE</span> MyDatabase<span class="token punctuation">;</span>     <span class="token comment">-- 设置当前数据库</span>

GO

<span class="token keyword">IF</span> OBJECT_ID<span class="token punctuation">(</span><span class="token string">'myPro1'</span><span class="token punctuation">,</span><span class="token string">'P'</span><span class="token punctuation">)</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token comment">-- 判断是否已存在名为“myPro1”存储过程</span>

    <span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> myPro1<span class="token punctuation">;</span>    <span class="token comment">-- 如果存在则删除，否则无法创建（不是必备代码）</span>

GO

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> myPro1   <span class="token comment">-- 定义存储过程myPro1</span>

<span class="token keyword">AS</span>

    <span class="token keyword">SELECT</span> s_no<span class="token punctuation">,</span> s_name<span class="token punctuation">,</span> s_avgrade<span class="token punctuation">,</span> s_dept

    <span class="token keyword">FROM</span> student<span class="token punctuation">;</span>

GO 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>在SQL Server Management Studio中编写上述代码，然后运行此代码即可在服务器端生成存储过程myPro1，此后就可以调用此存储过程。</p> <p>调用一个存储过程，一般是用EXECUTE（或EXEC）语句来完成。但也可以直接将过程名当作一个条命令来执行。</p> <p>【例子】对于上面定义的过程myPro1，以下三种执行方式都是有效且等价的：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>myPro1<span class="token punctuation">;</span>             <span class="token comment">-- 这种没有EXECUTE或EXEC的执行方式必须位于批处理中的第一条语句</span>

<span class="token keyword">EXEC</span> myPro1<span class="token punctuation">;</span>        <span class="token comment">-- 这种格式通常用于嵌入到其他语言中</span>

<span class="token keyword">EXECUTE</span> myPro1<span class="token punctuation">;</span>     <span class="token comment">-- 这种格式通常用于嵌入到其他语言中</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>（带参数的存储过程）对于例9.1，进一步要求能够按照成绩段来查询学生的相关信息。满足本例要求的存储过程需要带参数，用于界定成绩段。该存储过程定义的代码如下：</p></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">USE</span> MyDatabase<span class="token punctuation">;</span>

GO

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> myPro2    <span class="token comment">-- 定义带两个参数的存储过程</span>

    <span class="token variable">@mingrade</span> <span class="token keyword">numeric</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span>     <span class="token comment">-- 参数@mingrade的默认值为60</span>

    <span class="token variable">@maxgrade</span> <span class="token keyword">numeric</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token comment">-- 参数@maxgrade没有设置默认值</span>

<span class="token keyword">AS</span>

    <span class="token comment">-- 查询平均成绩在@mingrade到@maxgrade之间的学生信息</span>

    <span class="token keyword">SELECT</span> s_no<span class="token punctuation">,</span> s_name<span class="token punctuation">,</span> s_avgrade<span class="token punctuation">,</span> s_dept 

    <span class="token keyword">FROM</span> student

    <span class="token keyword">WHERE</span> s_avgrade<span class="token operator">&gt;=</span> <span class="token variable">@mingrade</span> <span class="token operator">AND</span> s_avgrade <span class="token operator">&lt;=</span> <span class="token variable">@maxgrade</span><span class="token punctuation">;</span> 

GO
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>上述存储过程带有两个参数，所以调用该过程时必须为之指定相应的参数值。对于有默认值的参数，如果不指定参数值，则使用默认值，但调用格式要正确。例如，对于存储过程myPro2，可通过执行下列语句来查询平均成绩在60到90分之间的学生信息（它们都是等价的）：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">EXEC</span> myPro2 <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">;</span>

<span class="token constant">EXEC</span> myPro2 @mingrade <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span> @maxgrade <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>

<span class="token constant">EXEC</span> myPro2 @maxgrade <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">,</span> @mingrade <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>

<span class="token constant">EXEC</span> myPro2 @maxgrade <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span> <span class="token operator">--</span> 参数@mingrade使用默认值<span class="token number">60</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>但如果试图使用下列方式来执行过程myPro2，则是错误的或与题意相背：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">EXEC</span> myPro2 <span class="token number">90</span><span class="token punctuation">;</span>       <span class="token operator">--</span> 错误的调用格式，少了一个参数

<span class="token constant">EXEC</span> myPro2 <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">;</span>  <span class="token operator">--</span> 能成功调用，但与题意相背
 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>（带通配符参数的存储过程）创建一个存储过程，使之能够按照姓名模糊查询并列出学生的学号、姓名和平均成绩；如果在调用时不带参数，则列出所有学生的相关信息。</p></blockquote> <p>该存储过程使用带通配符的方法来实现，其代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">USE</span> MyDatabase<span class="token punctuation">;</span>

<span class="token constant">GO</span>

<span class="token constant">CREATE</span> <span class="token constant">PROCEDURE</span> myPro3          

    @s_name <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'%'</span>

<span class="token constant">AS</span> 

    <span class="token constant">SELECT</span> s_no<span class="token punctuation">,</span> s_name<span class="token punctuation">,</span> s_avgrade<span class="token punctuation">,</span> s_dept 

    <span class="token constant">FROM</span> student

    <span class="token constant">WHERE</span> s_name <span class="token constant">LIKE</span> @s_name<span class="token punctuation">;</span> 

<span class="token constant">GO</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>调用该过程时，如果带参数值则按姓名进行模糊查询，如果不带参数值则列出所有学生的相关信息。</p> <p>【例子】下列语句将列出所有的姓“王”的学生信息：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">EXEC</span> myPro3 <span class="token string">'王%'</span><span class="token punctuation">;</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>而执行下列语句后则列出所有学生的学号、姓名和平均成绩：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">EXEC</span> myPro3<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>（带OUTPUT参数的存储过程）创建一个存储过程，使之能够求出所有学生成绩的总和以及女学生成绩的总和。</p></blockquote> <p>OUTPUT参数可以从存储过程中“带回”返回值，因此利用OUTPUT参数可以让存储过程具有返回值功能.本例中的存储过程要求有两个返回结果，因此在定义存储过程时需要声明带两个OUTPUT参数。</p> <p>定义该过程的代码如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">USE</span> MyDatabase<span class="token punctuation">;</span>

GO

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> myPro4      

    @ s_total <span class="token keyword">real</span> OUTPUT<span class="token punctuation">,</span>                                  <span class="token comment">--声明OUTPUT参数</span>

    @ s_total _female <span class="token keyword">real</span> OUTPUT<span class="token punctuation">,</span>           <span class="token comment">--声明OUTPUT参数</span>

<span class="token keyword">AS</span>

    <span class="token keyword">SELECT</span> @ s_total <span class="token operator">=</span><span class="token function">SUM</span><span class="token punctuation">(</span>s_avgrade<span class="token punctuation">)</span>                     <span class="token comment">--求所有学生成绩总和</span>

    <span class="token keyword">FROM</span> student<span class="token punctuation">;</span>

    <span class="token keyword">SELECT</span> @ s_total _female <span class="token operator">=</span><span class="token function">SUM</span><span class="token punctuation">(</span>s_avgrade<span class="token punctuation">)</span>              <span class="token comment">--求女学生成绩总和</span>

    <span class="token keyword">FROM</span> student

   <span class="token keyword">WHERE</span> s_sex<span class="token operator">=</span>‘女’

GO
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>对于带OUTPUT参数的存储过程，其调用方法与其他的存储过程的调用方法有所不同。首先要声明相应的变量来存放返回结果，然后在调用过程的时候要带关键字OUTPUT，否则无法将返回结果保存下来。</p> <p>【例子】要获取存储过程myPro4返回的结果并打印出来，相应的代码如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DECLARE</span> <span class="token variable">@total</span> <span class="token keyword">real</span><span class="token punctuation">,</span> <span class="token variable">@total_female</span> <span class="token keyword">real</span><span class="token punctuation">;</span>

<span class="token keyword">EXEC</span> myPro4 <span class="token variable">@total</span> OUTPUT<span class="token punctuation">,</span> <span class="token variable">@total_female</span> OUTPUT<span class="token punctuation">;</span>  <span class="token comment">-- 调用时要带关键字OUTPUT</span>

<span class="token keyword">print</span> <span class="token variable">@total</span><span class="token punctuation">;</span>

<span class="token keyword">print</span> <span class="token variable">@total_female</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>（加密存储过程）创建一个加密的存储过程。</p></blockquote> <p>加密存储过程是指在存储过程被创建后对保存在服务器端的过程文本代码进行加密，从而无法使用文本编辑器来查看代码。</p> <p>加密存储过程的方法很简单，只要在定义时使用WITH ENCRYPTION子句即可。以下是一个加密存储过程的定义代码：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">USE</span> MyDatabase<span class="token punctuation">;</span>        

GO

<span class="token keyword">CREATE</span> PRO CEDURE myPro5   <span class="token keyword">WITH</span> ENCRYPTION          

<span class="token keyword">AS</span>

    <span class="token keyword">SELECT</span> s_no<span class="token punctuation">,</span> s_name<span class="token punctuation">,</span> s_avgrade<span class="token punctuation">,</span> s_dept

    <span class="token keyword">FROM</span> student<span class="token punctuation">;</span>

GO
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>一个存储过程的定义文本可以用系统存储过程sp_helptext来查看。但执行下列语句后，会显示对象已加密的信息，这表示myPro5的定义文本已经被加密：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">EXEC</span> sp_helptext myPro5<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>存储过程的修改和删除</strong></p> <blockquote><p>修改存储过程</p></blockquote> <p>存储过程的修改可用ALTER PROCEDURE语句来实现，修改后用户对该存储过程拥有的权限并没有发生改变。</p> <p>ALTER PROCEDURE语句的语法如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> { <span class="token keyword">PROC</span> <span class="token operator">|</span> <span class="token keyword">PROCEDURE</span> } <span class="token punctuation">[</span>schema_name<span class="token punctuation">.</span><span class="token punctuation">]</span> procedure_name <span class="token punctuation">[</span> <span class="token punctuation">;</span> number <span class="token punctuation">]</span>
    <span class="token punctuation">[</span> { <span class="token variable">@parameter</span> <span class="token punctuation">[</span> type_schema_name<span class="token punctuation">.</span> <span class="token punctuation">]</span> data_type }
    <span class="token punctuation">[</span> <span class="token keyword">VARYING</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token operator">=</span> <span class="token keyword">default</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token keyword">OUT</span> <span class="token punctuation">[</span> PUT <span class="token punctuation">]</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>n <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token keyword">WITH</span> <span class="token operator">&lt;</span>procedure_option<span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>n <span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token keyword">FOR</span> <span class="token keyword">REPLICATION</span> <span class="token punctuation">]</span>
<span class="token keyword">AS</span>
     { <span class="token operator">&lt;</span>sql_statement<span class="token operator">&gt;</span> <span class="token punctuation">[</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>n <span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token operator">&lt;</span>method_specifier<span class="token operator">&gt;</span> }
<span class="token operator">&lt;</span>procedure_option<span class="token operator">&gt;</span> ::<span class="token operator">=</span>
    <span class="token punctuation">[</span> ENCRYPTION <span class="token punctuation">]</span>
    <span class="token punctuation">[</span> RECOMPILE <span class="token punctuation">]</span>
    <span class="token punctuation">[</span> EXECUTE_AS_Clause <span class="token punctuation">]</span>
<span class="token operator">&lt;</span>sql_statement<span class="token operator">&gt;</span> ::<span class="token operator">=</span> { <span class="token punctuation">[</span> <span class="token keyword">BEGIN</span> <span class="token punctuation">]</span> statements <span class="token punctuation">[</span> <span class="token keyword">END</span> <span class="token punctuation">]</span> }
<span class="token operator">&lt;</span>method_specifier<span class="token operator">&gt;</span> ::<span class="token operator">=</span> EXTERNAL NAME assembly_name<span class="token punctuation">.</span>class_name<span class="token punctuation">.</span>method_name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>注意：如果原来的存储过程在定义时使用了WITH ENCRYPTION或WITH RECOMPILE选项，那么只有在ALTER PROCEDURE语句中也选择了这些选项，这些选项才有效；另外，使用ALTER PROCEDURE修改后，原过程的权限和属性将保持不变。</p> <blockquote><p>对创建的存储过程myPro3进行修改，使之能够按照姓名（s_name）或系别（s_dept）进行查询。</p></blockquote> <p>该修改操作可用下列的ALTER PROCEDURE来实现。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">PROCEDURE</span> myPro3                

    <span class="token variable">@s_name</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'赵%'</span><span class="token punctuation">,</span>

    <span class="token variable">@s_dept</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'%'</span>

<span class="token keyword">AS</span> 

    <span class="token keyword">SELECT</span> s_no<span class="token punctuation">,</span> s_name<span class="token punctuation">,</span> s_avgrade<span class="token punctuation">,</span> s_dept 

    <span class="token keyword">FROM</span> student

    <span class="token keyword">WHERE</span> s_name <span class="token operator">LIKE</span> <span class="token variable">@s_name</span> <span class="token operator">OR</span> s_dept <span class="token operator">LIKE</span> <span class="token variable">@s_dept</span><span class="token punctuation">;</span>

GO
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language- extra-class"><pre><code>   修改后的过程与原来过程的权限完全一样。不同的是它除了可以按姓名查询外，还可以按系别查询。
</code></pre></div><p>在SSMS中修改存储过程的方法是，在对象资源管理中右击要修改的存储过程所对应的节点，并在弹出的菜单中选择“修改”命令，然后在打开的查询编辑器窗口中修改过程的定义代码即可。但对加密存储过程，则无法用这种方法修改。</p> <blockquote><p>删除存储过程</p></blockquote> <p>当一个存储过程不再使用时，就应该将它从数据库中删除。删除一个存储过程的SQL语句是DROP PROCEDURE。实际上，在前面介绍的例子中已经多次用到。其语法如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">DROP</span> <span class="token punctuation">{</span> <span class="token constant">PROC</span> <span class="token operator">|</span> <span class="token constant">PROCEDURE</span> <span class="token punctuation">}</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span> schema_name<span class="token punctuation">.</span> <span class="token punctuation">]</span> procedure <span class="token punctuation">}</span> <span class="token punctuation">[</span> <span class="token punctuation">,</span><span class="token operator">...</span>n <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- extra-class"><pre><code> 从该语法中可以看出，一条DROP PROCEDURE语句可以同时删除一个或多个存储过程。
</code></pre></div><p>同时删除过程myPro1, myPro2, myPro3，可使用下列语句来完成：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">DROP</span> <span class="token constant">PROCEDURE</span> myPro1<span class="token punctuation">,</span> myPro2<span class="token punctuation">,</span> myPro3<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可以在SSMS中删除一个存储过程。方法是：在对象资源管理器中右击要删除的存储过程所对应的节点，然后在弹出的菜单中选择“删除”命令，最后根据提示删除存储过程。</p> <p>注意，当一个存储过程被删除以后，所有用户对其拥有的操作权限也将全部被删除。</p></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2/24/2025, 4:18:47 PM</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/MyBlog/assets/js/app.9dfd65aa.js" defer></script><script src="/MyBlog/assets/js/3.76fec40c.js" defer></script><script src="/MyBlog/assets/js/1.0933c2a3.js" defer></script><script src="/MyBlog/assets/js/19.3947f2e5.js" defer></script>
  </body>
</html>
